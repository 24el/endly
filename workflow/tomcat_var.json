[
  {
    "Name": "targetHost",
    "From": "params.targetHost",
    "Required":true
  },
  {
    "Name": "targetCredential",
    "From": "params.targetCredential",
    "Required":true
  },
  {
    "Name": "tomcatMajorVersion",
    "From": "params.tomcatMajorVersion",
    "Value": "7"
  },

  {
    "Name": "tomcatVersion",
    "From": "params.tomcatVersion",
    "Value": "7.0.81"
  },
  {
    "Name": "catalinaOpts",
    "From": "params.catalinaOpts",
    "Value": "-Xms512m -Xmx1g -XX:MaxPermSize=256m"
  },
  {
    "Name": "tomcatPort",
    "From": "params.tomcatPort",
    "Value": "8080"
  },
  {
    "Name": "jpdaAddress",
    "From": "params.jpdaAddress",
    "Value": "5000"
  },
  {
    "Name": "tomcatShutdownPort",
    "From": "params.tomcatShutdownPort",
    "Value": "8005"
  },
  {
    "Name": "tomcatAJPConnectorPort",
    "From": "params.tomcatAJPConnectorPort",
    "Value": "8009"
  },
  {
    "Name": "tomcatRedirectPort",
    "From": "params.tomcatRedirectPort",
    "Value": "8443"
  },
  {
    "Name": "jdkVersion",
    "From": "params.jdkVersion",
    "Value": "1.7"
  },
  {
    "Name": "appDirectory",
    "Value": "$params.appDirectory"
  },
  {
    "Name": "forceDeploy",
    "From": "params.forceDeploy",
    "Value": false
  },
  {
    "Name": "configUrl",
    "From": "params.configUrl",
    "Required":true
  },
  {
    "Name": "configUrlCredential",
    "From": "params.configUrlCredential",
    "Required":true
  },
  {
    "Name": "tomcat",
    "Value": "apache-tomcat-${tomcatVersion}"
  },
  {
    "Name": "setRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "Sdk": "jdk",
      "Version": "$jdkVersion"
    }
  },
  {
    "Name": "checkRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "Name": "catalina | grep ${appDirectory}/tomcat"
    }
  },
  {
    "Name": "killRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "Pid": "$tomcatPid"
    }
  },
  {
    "Name": "startRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "ManagedCommand": {
        "Options": {
          "Env": {
            "CATALINA_OPTS": "$catalinaOpts",
            "JPDA_ADDRESS":"$jpdaAddress"
          },

          "Directory": "$appDirectory"
        },
        "Executions": [
          {
            "Command": "tomcat/bin/catalina.sh jpda start",
            "Success": [
              "Tomcat started."
            ],
            "Extraction": [
              {
                "Key": "Version",
                "RegExpr": "Server number: (\\d+\\.\\d+\\.\\d+)"
              }
            ]
          }
        ]
      }
    }
  },
  {
    "Name": "stopRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "ManagedCommand": {
        "Options": {
          "Directory": "$appDirectory"
        },
        "Executions": [
          {
            "Command": "tomcat/bin/shutdown.sh"
          }
        ]
      }
    }
  },
  {
    "Name": "deployRequest",
    "Value": {
      "Force": "$forceDeploy",
      "Sdk": "jdk",
      "SdkVersion": "$jdkVersion",
      "Pre": {
        "SuperUser": true,
        "Commands": [
          "rm -rf $appDirectory",
          "mkdir -p $appDirectory",
          "chmod  -R a+w $appDirectory"
        ]
      },
      "Transfer": {
        "Source": {
          "URL": "http://mirror.metrocast.net/apache/tomcat/tomcat-${tomcatMajorVersion}/v${tomcatVersion}/bin/${tomcat}.tar.gz"
        },
        "Target": {
          "Name": "tomcat",
          "Version": "$tomcatVersion",
          "URL": "file://${appDirectory}",
          "Credential": "$targetCredential"
        }
      },
      "Command": {
        "Options": {
          "Directory": "$appDirectory"
        },
        "Executions": [
          {
            "Command": "tar xvzf ${tomcat}.tar.gz",
            "Error": [
              "Error"
            ]
          },
          {
            "Command": "mv ${tomcat} tomcat",
            "Error": [
              "No"
            ]
          }
        ]
      },
      "VersionCheck": {
        "Executions": [
          {
            "Command": "sh tomcat/bin/version.sh",
            "Extraction": [
              {
                "Key": "Version",
                "RegExpr": "Apache Tomcat/(\\d+\\.\\d+\\.\\d+)"
              }
            ]
          }
        ]
      },
      "Post": {
        "SuperUser": true,
        "Commands": [
          "mkdir -p $appDirectory/tomcat/logs",
          "chmod -R a+w  $appDirectory"
        ],
        "Transfers": [
          {
            "Source": {
              "URL": "$configUrl",
              "Credential": "$configUrlCredential"
            },
            "Target": {
              "URL": "scp://${targetHost}${appDirectory}/tomcat/conf/server.xml",
              "Credential": "$targetCredential"
            },
            "Expand": true
          }
        ]
      }
    }
  }
]