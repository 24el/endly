[
  {
    "Name": "targetHost",
    "Value": "$params.targetHost"
  },
  {
    "Name": "tomcat",
    "Value": "apache-tomcat-${params.tomcatVersion}"
  },
  {
    "Name":"app",
    "From":"params.app"
  },


  {
    "Name":"tomcatPort",
    "From":"params.tomcatPort",
    "Value":"8080"
  },
  {
    "Name":"tomcatShutdownPort",
    "From":"params.tomcatShutdownPort",
    "Value":"8005"
  },
  {
    "Name":"tomcatAJPConnectorPort",
    "From":"params.tomcatPort",
    "Value":"8009"
  },
  {
    "Name":"tomcatRedirectPort",
    "From":"params.tomcatPort",
    "Value":"8443"
  },

  {
    "Name": "jdkVersion",
    "From": "params.jdkVersion",
    "Value": "1.7"
  },
  {
    "Name": "tomcatVersion",
    "From": "params.tomcatVersion"
  },
  {
    "Name": "appDirectory",
    "Value": "$params.appDirectory"
  },

  {
    "Name":"forceDeploy",
    "From":"params.forceDeploy",
    "Value":false
  },

  {
    "Name": "setRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credential": "$targetCredential"
      },
      "Sdk": "jdk",
      "Version": "$params.jdkVersion"
    }
  },
  {
    "Name": "checkRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credentail": "$targetCredential"
      },
      "Command": "catalina | grep ${appDirectory}/tomcat"
    }
  },
  {
    "Name": "killRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credentail": "$targetCredential"
      },
      "Pid": "$tomcatPid"
    }
  },
  {
    "Name": "startRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credentail": "$targetCredential"
      },
      "ManagedCommand": {
        "Options": {
          "Env": {
            "CATALINA_OPTS": "$params.catalinaOpts"
          },
          "Directory": [
            "$appDirectory"
          ]
        },
        "Executions": [
          {
            "Command": "tomcat/bin/catalina.sh start",
            "Success": [
              "Tomcat started."
            ],
            "Extraction": [
              {
                "Key": "Version",
                "RegExpr": "Server number: (\\d+\\.\\d+\\.\\d+)"
              }
            ]
          }
        ]
      }
    }
  },
  {
    "Name": "stopRequest",
    "Value": {
      "Target": {
        "URL": "ssh://${targetHost}${appDirectory}/",
        "Credentail": "$targetCredential"
      },
      "ManagedCommand": {
        "Options": {
          "Directory": [
            "$appDirectory"
          ]
        },
        "Executions": [
          {
            "Command": "tomcat/bin/shutdown.sh"
          }
        ]
      }
    }
  },
  {
    "Name": "deployRequest",
    "Value": {
      "Force":"$forceDeploy",
      "Sdk": "jdk",
      "SdkVersion": "$jdkVersion",
      "Pre": {
        "SuperUser": true,
        "Commands": [
          "rm -rf $appDirectory",
          "mkdir -p $appDirectory",
          "chmod  -R a+w $appDirectory"
        ]
      },
      "Transfer": {
        "Source": {
          "URL": "http://mirror.metrocast.net/apache/tomcat/tomcat-${params.tomcatMajorVersion}/v${params.tomcatVersion}/bin/${tomcat}.tar.gz"
        },
        "Target": {
          "Name": "tomcat",
          "Version": "$tomcatVersion",
          "URL": "scp://${targetHost}${appDirectory}/",
          "Credentail": "$targetCredential"
        }
      },
      "Command": {
        "Options": {
          "Directory": "$appDirectory"
        },
        "Executions": [
          {
            "Command": "tar xvzf ${tomcat}.tar.gz",
            "Error": [
              "Error"
            ]
          },
          {
            "Command": "mv ${tomcat} tomcat",
            "Error": [
              "No"
            ]
          }
        ]
      },
      "VersionCheck": {
        "Executions": [
          {
            "Command": "sh tomcat/bin/version.sh",
            "Extraction": [
              {
                "Key": "Version",
                "RegExpr": "Apache Tomcat/(\\d+\\.\\d+\\.\\d+)"
              }
            ]
          }
        ]
      },
      "Post": {
        "SuperUser": true,
        "Commands": [
          "mkdir -p $appDirectory/tomcat/logs",
          "chmod -R a+w  $appDirectory"
        ],
        "Transfers":[
          {
            "Source": {
              "URL": "$params.configUrl",
              "Credential": "$params.configUrlCredential"
            },
            "Target": {
              "URL": "scp://${targetHost}${appDirectory}/tomcat/config/server.xml",
              "Credentail": "$targetCredential"
            },
            "Expand": true
          }
        ]
      }
    }
  }

]